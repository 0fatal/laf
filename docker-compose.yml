version: '3.8'
services: 
  mongo:
    image: bitnami/mongodb:latest
    environment: 
      - ALLOW_EMPTY_PASSWORD=yes
      - MONGODB_REPLICA_SET_MODE=primary
      - MONGODB_INITIAL_PRIMARY_HOST=mongo
      - MONGODB_REPLICA_SET_NAME=rs0
    volumes:
      - db-data:/bitnami/mongodb
    networks: 
      - laf

  devops_server:
    image: lessx/laf-devops-server:latest
    user: node
    environment: 
      SYS_DB: laf-sys
      SYS_DB_URI: mongodb://mongo:27017
      SYS_DB_POOL_LIMIT: 10
      SYS_SERVER_SECRET_SALT: Rewrite_Your_Own_Secret_Salt_devops_server
      SYS_ADMIN: laf-sys
      SYS_ADMIN_PASSWORD: laf-sys
      LOG_LEVEL: debug
      APP_DB: laf-app
      APP_DB_URI: mongodb://mongo:27017
      APP_DB_POOL_LIMIT: 10
      APP_SERVER_SECRET_SALT: Rewrite_Your_Own_Secret_Salt_app_server
    command: dockerize -wait tcp://mongo:27017 npm run init-start
    ports:
      - "9000:9000"
    read_only: true
    depends_on: 
      - mongo
    cap_drop: 
      - ALL
    tmpfs: 
      - /tmp
    restart: always
    networks: 
      - laf

  app_server:
    image: lessx/laf-app-server:latest
    user: node
    environment: 
      DB: laf-app
      DB_URI: mongodb://mongo:27017
      DB_POOL_LIMIT: 100
      SERVER_SECRET_SALT: Rewrite_Your_Own_Secret_Salt_app_server
      LOG_LEVEL: debug
      ENABLE_CLOUD_FUNCTION_LOG: always
    command: dockerize -wait http://devops_server:9000/health-check npm run start
    volumes:
      - app-data:/app/data
    ports:
      - "8000:8000"
    read_only: false
    depends_on: 
      - devops_server
      - mongo
    cap_drop: 
      - ALL
    tmpfs: 
      - /tmp
    restart: always
    networks: 
      - laf

  devops_admin:
    image: lessx/laf-devops-admin:latest
    depends_on: 
      - app_server
      - devops_server
      - mongo
    ports: 
      - 8080:80
    networks: 
      - laf

networks:
  laf:
      
volumes:
  app-data:
  db-data:
      